# 常量表达优化
对于常数表达优化主要包含两个方面
1. 将const变量转化为数值
2. 计算常数表达式

这两处优化的实现都集中在semant.cpp中的transExp函数中。
transExp有一个重要的保证：保证所有可优化的常量表达式都被
优化为数值，并且就地修改ast为A_intExp。

下面具体介绍两种情况的优化

## const变量优化
const变量优化时有三种情况：
1. 非数组const变量
2. 数组const变量，索引中全为常量表达式
3. 数组const变量，索引中不全为常量表达式

对于情况1：值环境符号表中存储着非数组const变量的值，
可直接看作宏定义，替换为相应的数值。

对于情况2：索引中都为常量表达式，由于transExp保证常量表达
都被优化为数值。则，该情况也可看作宏定义。值环境符号表中
保存着const数组的所有值。根据被transExp优化过的索引，
即可替换相应的数值

对于情况3：索引中含有非常量表达，这导致对该const数组的访问
需要等到运行时才能确定。此时，应该将其看作普通数组处理。

**如何区分情况2和情况3？**

在访问数组变量时，会调用transVar函数。在处理数组的
case：A_arrayVar中，会递归处理每一维度的索引(transExp)。
transExp返回信息expty中的isConst域隐含了该纬度是否为
常量表达式。这样结合该数组是否为const以及索引是否全为const
即可区分情况2/3.


## 常量表达式
常量表达式优化指：若exp op exp中两个exp都为constExp
则将exp op exp优化为一个exp(A_intExp)。
由于transExp的保证，在优化时，只需判断两个exp是否为A_intExp
(或返回的expty信息中的isConst是否为true)。


在上述两个过程中，对expty中的isConst域赋予了两个新职责。目前
isConst的职责有：
1. 由transVar返回，表示访问的改变量是否为const
2. 由transVar返回，表示访问的数值是否是可优化的
3. 由transExp返回，暗示exp是否被优化为了A_intExp

其中第3个职责不是必须的(写文档才意识到这个问题= =)

## 问题
+ 目前的实现没有考虑内存管理，优化过程中一定会产生内存泄漏。
具体泄漏对象请看transExp中的注释。
+ 对于常量数组的情况2的替换操作，由于涉及数组初值的处理，
暂未实现

